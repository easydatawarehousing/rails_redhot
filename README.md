# RailsRedhot gem
__REDux pattern for HOTwire == Redhot__  
Single page applications using redux (react) are very popular.
And with good reason, redux makes maintaining the current state of the app easy.
For instance when building some kind of editor, every action of the user is added
to the redux store. All actions can be reduced to the determine the current state of
the editor. Views are rendered using the current state.  
Or when building a search page for a webshop. Whenever the user selects a category
or price range to filter on this can be an action for the redux store. If the user
hits the back button the last action can be deleted and the current state
regenerated by reducing all remaining actions. The user only sees the last filter
being reverted to what it was before.  
Sometimes the actions of the user in the frontend should be sent to a backend
application. For instance when actions of multiple users should be kept in-sync.
Often command-query-responsibility-separation (CQRS) is used for this purpose.
These solutions can become very complex
([example](https://medium.com/resolvejs/resolve-redux-backend-ebcfc79bbbea)
scroll down a bit).

The Hotwire (Html Over The Wire) approach does an excellent job of removing the need
to build single page apps. Hotwire will be the
[default tool](https://world.hey.com/dhh/the-time-is-right-for-hotwire-ecdb9b33)
for frontend development in Rails 7.
However when using hotwire the responsibilty of maintaining frontend state entirely
falls to the backend application. So when building your editor or search page
you need a way to keep track of that state. The redux (also known as flux) pattern
is still very useful for this purpose.

This gem aims to combine html-over-the-wire approach with the redux pattern to
radically reduce complexity of the overall application.
(At least when compared to for instance react+cqrs.)
Only four components are required:

1. Views, normal rails views rendering the current state and delivered as turbo frames
2. Actions, just (submit) buttons that send a request to the backend
3. Store, keeping the list of actions and current state, managed by this gem and stored
   in an activerecord model
4. Reducers, a set of functions (provided by you) that translate actions to changes in state

Common actions (undo, redo, flatten actions to initial state) are provided by this gem.
Combined with turbo frames for rendering partial page updates this makes it easy to
create a very smooth user experience.

## Usage
Create a migration to add a 'text' type attribute to a model that should have a redux store.
In the model add an `acts_as_redux` line, specifying the name of the text attribute.
Add a private method holding all your reducer functions.
See [this example](test/dummy/app/models/foobar.rb).
Note that all reducer functions must return the state object (a Hash).

```ruby
include RailsRedhot::ActsAsRedux

acts_as_redux :my_redux

private

def my_redux_reducers
->(state, action) {
  case action[:type]
  when :add
    state[:total] += 1
  when :remove
    state[:total] -= 1
  end
  state
},
end
```

Or specify your own reducer method:

```ruby
acts_as_redux :my_redux, reducers: :list_of_reducers

def list_of_reducers
# ...
```

In your views add some submit buttons for adding and undoing actions.
See [this example](test/dummy/app/views/foobars/_editor.html.erb).
And let your controller ([example](test/dummy/app/controllers/foobars_controller.rb))
process these actions.  
See section [Demo application](https://github.com/easydatawarehousing/rails_redhot#demo-application)
for a working example.

## Installation
Add this line to your application's Gemfile:

```ruby
gem "rails_redhot"
```

And then execute:
```bash
$ bundle
```

Or install it yourself as:
```bash
$ gem install rails_redhot
```

## Demo application
To use the demo application, clone the repo and run rails:

```bash
git clone https://github.com/easydatawarehousing/rails_redhot.git
cd rails_redhot
bundle install
cd test/dummy
rails db:setup
rails server
```

Open the [application](http://localhost:3000/foobars).
Click on 'New foobar', 'Add a new foobar' and 'Edit this foobar'.

## Test
Run:

```bash
rails test/dummy/test
```

## License
The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).

## Remarks

- Developed using Ruby 3.0.3
- This gem is not designed to handle very large lists of actions and state.
  When calling `undo` the state is rebuilt from scratch
  If the list of actions to process is large this would become slow.
  One would need add 'savepoints' that regularly save the state and rebuild
  the current state from that point forward
- No checking on the size of the text attribute used for the store is done
- Currently only one redux store can be added to a model
- Redux store code inspired by:
  - https://gist.github.com/eadz/31c87375722397be861a0dbcf7fb7408
  - https://github.com/janlelis/redux.rb
